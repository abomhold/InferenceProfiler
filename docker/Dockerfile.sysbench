# Build profiler
FROM golang:1.22 AS builder
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o infprofiler .

# Runtime with sysbench
FROM ubuntu:24.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    sysbench \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /build/infprofiler /usr/local/bin/infprofiler
RUN mkdir -p /output
WORKDIR /app

# Profile sysbench CPU test (no GPU/vLLM)
ENTRYPOINT ["infprofiler", "profile", "-no-nvidia", "-no-vllm", "-dir", "/output", "-format", "parquet", "--"]
CMD ["sysbench", "cpu", "--threads=4", "--time=30", "run"]
