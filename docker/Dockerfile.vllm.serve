# Build profiler
FROM golang:1.22 AS builder
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o infprofiler .

# Runtime with vLLM
FROM ubuntu:24.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates python3-pip \
    && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir --break-system-packages vllm

COPY --from=builder /build/infprofiler /usr/local/bin/infprofiler
COPY docker/entrypoint-serve.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

WORKDIR /app

# Expose profiler metrics server and vLLM API
EXPOSE 8081 8000

# Entrypoint starts profiler serve in background, then runs CMD
ENTRYPOINT ["/entrypoint.sh"]
CMD ["vllm", "serve", "/app/model", "--host", "0.0.0.0", "--port", "8000", "--gpu-memory-utilization=0.7", "--max-model-len=2048"]
