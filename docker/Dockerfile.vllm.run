# Build profiler
FROM golang:1.22 AS builder
WORKDIR /build
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o infprofiler .

# Runtime with vLLM
FROM ubuntu:24.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates python3-pip \
    && rm -rf /var/lib/apt/lists/*

RUN pip install --no-cache-dir --break-system-packages vllm

COPY --from=builder /build/infprofiler /usr/local/bin/infprofiler
RUN mkdir -p /output
WORKDIR /app

# Profile vLLM batch generation
ENTRYPOINT ["infprofiler", "profile", "-interval", "10ms", "-dir", "/output", "-format", "parquet", "--"]
CMD ["python3", "-c", \
     "from vllm import LLM, SamplingParams; \
      llm = LLM(model='/app/model', gpu_memory_utilization=0.8, max_model_len=2048); \
      params = SamplingParams(max_tokens=256); \
      prompts = ['Explain TCP vs UDP.'] * 100; \
      print(llm.generate(prompts, params))"]
